<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
    <!-- load external qr js -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script>
      /**
       * Configuration goes here
       */
      // Format: https://api.github.com/repos/{owner}/{repo}/issues/
      var GITHUB_ISSUES_LINK =
        "https://api.github.com/repos/sorat0mo/url-short/issues/";
      var PATH_SEGMENTS_TO_SKIP = 0;
      // Github username (will only redirect for issues by this user)
      var ME = "sorat0mo";

      /**
       * DO NOT TOUCH ANYTHING BELOW THIS COMMENT UNLESS YOU KNOW WHAT YOU ARE DOING
       */

      function isNumeric(num){ return !isNaN(num) }
      function isUrl(url) {
        // Regex from https://stackoverflow.com/a/3809435, with a modification to allow for TLDs of up to 24 characters
        return /^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,24}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)+$/.test(url);
      }

      var isQuery = window.location.href.substr(-1) == "?";
      var keyword = window.location.pathname.split("/")[PATH_SEGMENTS_TO_SKIP + 1];

      function renderSafeLink(containerId, url) {
        const container = document.getElementById(containerId);
        container.textContent = ""; // Clear previous content

        if (!isUrl(url)) {
          container.textContent = url; // Just show the message if not a real URL
          return;
        }

        const a = document.createElement("a");
        a.href = url;
        a.textContent = url;
        a.rel = "noopener noreferrer";
        a.target = "_blank";
        container.appendChild(a);
      }

      var xhr = new XMLHttpRequest();
      xhr.onload = function () {
      	var issue = "";
	var url = "";
	if (isNumeric(keyword)) {
		if (xhr.status == 200) {
			var payload = JSON.parse(xhr.response);
			issue = payload;
		} else {
      // Issue number not found, fall through to slug search or error
			issue = "";
		}
	} else {
		var payload = JSON.parse(xhr.response);
		for (var i = 0; i < payload.length; i++) {
			if (payload[i].body == keyword) {
				issue = payload[i];
				break;
			}
		}
	}
		if (issue != "") {
			if (issue.user && issue.user.login == ME) {
				if (issue.state != "closed") {
					url = "Issue not closed, not redirecting.";
				} else {
					url = issue.title;
				}
			} else {
				url = "Failed authentication (GitHub Issue not created by owner of repository)";
			}
		} else {
			url = "Slug or issue not found."; // Show this for both missing issues and slugs
		}

        // update page with safe clickable link
        renderSafeLink("link", url);

        // if current url ends in '?', just display the full url & QR
        if (isUrl(url) && !isQuery) {
          // redirect user
          window.location.replace(url);
        }
        // Always render QR code for valid URLs, even if not redirecting
        if (isUrl(url)) {
          var qr = new QRious({
            element: document.getElementById('qrcode'),
            value: url,
            size: 200
          });
        }
      }

      // Send XHR request
      var api_url = GITHUB_ISSUES_LINK;
      // Get /issues/ID
      if (isNumeric(keyword)) { api_url += keyword; }
      else { api_url = api_url.slice(0, -1) + "?state=all&per_page=100"; }
      xhr.open("GET", api_url);
      xhr.send();

    </script>
  </head>
  <body>
    <h1 id="link">If you see this, it means the script is not working.</h1>
    <canvas id="qrcode"></canvas>
  </body>
</html>
